# .-.aliases.nginx
# Used to add anything Nginx specific

# Determine nginx path for OS X or Ubuntu
nginxPath=`find /etc/nginx /usr/local/etc/nginx -d -maxdepth 1 -iname "nginx" 2>/dev/null | head -1`

# Check if the path is a directory
if [ -d "$nginxPath" ]; then
    test "$SILENT" == false && echo -e "*\tNginx\t\t\t\t*"
    
    # Convenience aliases 
    if [ -f /etc/init.d/nginx ]; then
    	alias nginx_start='echo " * Starting nginx"; sudo service nginx start'
    	alias nginx_stop='echo " * Stopping nginx"; sudo service nginx stop'
    	alias nginx_restart='sudo service nginx restart'
    	alias nginx_reload='sudo service nginx reload'
    	alias nginx_test='sudo service nginx configtest'
    fi
    
    if [ -d "$nginxPath/sites-available" ]; then
        alias nginx_sites_available='echo; echo Sites Available:; echo; cd $nginxPath/sites-available; ls; echo'	
    fi

    if [ -d "$nginxPath/sites-enabled" ]; then
        alias nginx_sites_enabled='echo; echo Sites Enabled:; echo; cd $nginxPath/sites-enabled; ls; echo'
    fi

    if [ -f "$nginxPath/nginx.conf" ]; then
    	alias nginx_config='sudo $EDITOR $nginxPath/nginx.conf'
    fi

    if [ -f /var/log/nginx/error.log ]; then
    	alias nginx_error_logs='sudo $EDITOR /var/log/nginx/error.log'
    fi

    if [ -f /var/log/nginx/access.log ]; then
    	alias nginx_access_logs='sudo $EDITOR /var/log/nginx/access.log'
    fi
    
    # Symlink a site from sites-available to sites-enabled directory
    nginx_enable_site() {
        if [ -f "$nginxPath/sites-available/$1" ]; then
            sudo ln "$nginxPath/sites-available/$1" "$nginxPath/sites-enabled/$1"
        else
            echo "Site: $1 -- Does not exist in $nginxPath/sites-available"
        fi
    }
    
    # Remove symlink from sites-enabled directory
    nginx_disable_site() {
        if [ -f "$nginxPath/sites-enabled/$1" ]; then
            rm "$nginxPath/sites-enabled/$1"
        else
            echo "Site: $1 -- Does not exist in $nginxPath/sites-enabled"
        fi
    }
    
    # Remove symlink from sites-enabled directory
    nginx_disable_site() {
        if [ -f "$nginxPath/sites-enabled/$1" ]; then
            rm "$nginxPath/sites-enabled/$1"
        else
            echo "Site: $1 -- Does not exist in $nginxPath/sites-enabled"
        fi
    }
    
    # Setup for creating a new site
    nginx_new_site() {
    
        # Where the project files will live
        printf "Web root (/var/www/): "
        read webRoot
    
        while [ ! -d "$webRoot" ]; do
            printf "Invalid directory\n"
            printf "Web root (/var/www/): "
            read webRoot
        done
    
        # Name of the site we are creating
        printf "Domain name (www.example.com): "
        read domainName
        sudo mkdir -p "$webRoot/$domainName" && echo "Created directory: $webRoot/$domainName"
    
    
        # Name of the user serving site
        printf "Web server user (www-data): "
        read userName
        sudo chown -R "$userName:$userName" "$webRoot/$domainName" && echo "Set $userName as owner on $webRoot/$domainName"
    
        # Create the virrtual hosts file
        sudo cp "$nginxPath/sites-available/default" "$nginxPath/sites-available/$domain" && echo "Created virtual host file: $nginxPath/sites-available/$domain"
        
        # Ask if they want to edit the hosts file
        while true; do
            read -p "Do you wish to edit this virtual hosts file?" yn
            case $yn in
                [Yy]* ) "$EDITOR $nginxPath/sites-available/$domain"; break;;
                [Nn]* ) exit;;
                * ) echo "Please answer yes or no.";;
            esac
        done
  
        echo "Site $domainName created as an available site."
  
        # Ask if they want to enable the site
        while true; do
            read -p "Do you wish to enable this site?" yn
            case $yn in
                [Yy]* ) nginx_enable_site "$domainName"; break;;
                [Nn]* ) echo "In order to enable it run the command 'nginx_enable_site $domainName'" && exit;;
                * ) echo "Please answer yes or no.";;
            esac
        done
    
        echo "Fin."
    } 
fi